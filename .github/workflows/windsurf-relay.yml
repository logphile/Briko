name: Windsurf Relay
on:
  issues:
    types: [opened, edited, labeled]
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  enqueue:
    if: github.event.issue.state == 'open' && contains(github.event.issue.labels.*.name, 'windsurf')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Append to AGENT_TASKS.md
        run: |
          f=AGENT_TASKS.md
          [ ! -f "$f" ] && echo -e "# Agent Tasks (source of truth)\n\n## Queue\n\n## Done" > "$f"
          esc_title="$(printf "%s" "${{ github.event.issue.title }} â€” ${{ github.event.issue.html_url }}" | sed 's/`/\\`/g')"
          esc_body="$(printf "%s" "${{ github.event.issue.body }}" | sed 's/`/\\`/g')"
          ins="- [ ] ${esc_title}\n\n${esc_body}\n"
          awk -v ins="$ins" 'BEGIN{p=0} /^## Queue/ && !p {print; print ins; p=1; next} {print}' "$f" > "$f.tmp" && mv "$f.tmp" "$f"
      - name: Open PR for queue update
        uses: peter-evans/create-pull-request@v6
        with:
          add-paths: AGENT_TASKS.md
          branch: ws-queue/${{ github.event.issue.number }}
          commit-message: "chore(queue): enqueue #${{ github.event.issue.number }}"
          title: "chore(queue): enqueue #${{ github.event.issue.number }}"
          body: "Auto-generated from issue."
          labels: automerge
      - uses: actions-ecosystem/action-add-comment@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          body: "Queued in **AGENT_TASKS.md** via PR. Windsurf will pick it up."
      - uses: peter-evans/close-issue@v3
